name: Update CHANGES.md with PR Title and Description on Merge

on:
  pull_request:
    types: [closed]
    branches: [main]  # Listen to merges into the main branch

jobs:
  update-changes-md:
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 2  # Fetch enough history to access all PR commits

      - name: Read version from version.properties
        id: read_version
        run: |
          # Extract version.name from version.properties in the root folder
          VERSION_NAME=$(grep 'version.name' version.properties | cut -d'=' -f2 | xargs)
          echo "VERSION_NAME=$VERSION_NAME" >> $GITHUB_ENV

      - name: Capture PR title, user ID, and PR description
        id: pr_info
        run: |
          # Capture the PR title, version name, and PR description
          PR_TITLE="${{ github.event.pull_request.title }}"
          PR_URL="${{ github.event.pull_request.html_url }}"
          PR_BODY="${{ github.event.pull_request.body }}"

          # Extract "### Changes For Release" section from PR description
          CHANGE_DESCRIPTION=$(echo "$PR_BODY" | sed -n '/### Changes For Release/,/### /p' | sed '1d')

          # Prepare the full changelog entry
          NEW_ENTRY="- ${PR_TITLE} [Link to PR]($PR_URL)"

          # Check if PR title already exists anywhere in CHANGES.md
          if grep -qF "${PR_TITLE}" app/CHANGES.md; then
            echo "PR title already exists in CHANGES.md. Skipping update."
            exit 0
          fi

          # Check if the version header already exists in CHANGES.md
          if grep -q "## ${VERSION_NAME}" app/CHANGES.md; then
            # If version header exists, add PR title and description with commit messages under it
            sed -i "/## ${VERSION_NAME}/a ${NEW_ENTRY}\n### Changes For Release\n<details><summary>Click to expand</summary>\n${CHANGE_DESCRIPTION}\n</details>" app/CHANGES.md
          else
            # If version header doesn't exist, create it with PR title and description at the top of the file
            echo -e "## ${VERSION_NAME}\n${NEW_ENTRY}\n### Changes For Release\n<details><summary>Click to expand</summary>\n${CHANGE_DESCRIPTION}\n</details>\n\n$(cat app/CHANGES.md)" > app/CHANGES.md
          fi

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Stage and amend the latest commit
        run: |
          git add app/CHANGES.md
          git commit --amend --no-edit
          git push origin HEAD:main --force  # Ensure you are pushing to the main branch
